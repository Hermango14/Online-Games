<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Catch the Box</title>

<style>
body {
  margin: 0;
  background: #111;
  color: white;
  font-family: Arial, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  touch-action: none; /* IMPORTANT for mobile dragging */
}

canvas {
  border: 2px solid white;
}

button {
  padding: 10px 20px;
  font-size: 16px;
}

#settingsBtn {
  position: absolute;
  top: 10px;
  right: 10px;
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
}

.menu {
  background: #222;
  padding: 20px;
  border-radius: 10px;
  width: 300px;
  text-align: center;
}

.close {
  float: right;
  cursor: pointer;
}

.colorBar {
  width: 200px;
  height: 20px;
  margin: 10px auto;
  border-radius: 10px;
  background: linear-gradient(to right, red, orange, yellow, green, cyan, blue, violet);
  position: relative;
}

.colorPicker {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid white;
  position: absolute;
  top: 1px;
}
</style>
</head>

<body>

<button id="settingsBtn">Settings</button>
<canvas id="game" width="400" height="600"></canvas>

<!-- MAIN MENU -->
<div class="overlay" id="mainMenu" style="display:flex;">
  <div class="menu">
    <h2>Catch the Box</h2>
    <button onclick="startGame('default')">Default</button><br><br>
    <button onclick="startGame('normal')">Normal</button><br><br>
    <button onclick="startGame('hard')">Hard</button>
  </div>
</div>

<!-- SETTINGS -->
<div class="overlay" id="settingsMenu">
  <div class="menu">
    <span class="close" onclick="closeSettings()">âœ–</span>
    <h3>Settings</h3>

    <p>Box Color</p>
    <div class="colorBar" data-target="box"><div class="colorPicker"></div></div>

    <p>Paddle Color</p>
    <div class="colorBar" data-target="paddle"><div class="colorPicker"></div></div>

    <p>Background Color</p>
    <div class="colorBar" data-target="bg"><div class="colorPicker"></div></div>

    <p>Drag paddle to move</p>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let paddle, box, score;
let gameState = "menu"; // menu | playing | paused | gameover
let mode = "normal";

let boxColor = "#ff4d4d";
let paddleColor = "#00ffee";
let bgColor = "#222";

let highScore = Number(localStorage.getItem("highScore") || 0);
let beatHighScore = false;

const keys = {};
let dragging = false;

/* ---------- GAME ---------- */
function startGame(m) {
  mode = m;
  document.getElementById("mainMenu").style.display = "none";
  init();
  gameState = "playing";
}

function init() {
  paddle = { x: 160, y: 570, w: 80, h: 15, speed: 7 };
  box = { x: Math.random()*370, y: 0, s: 30, speed: 2.5 };
  score = 0;
  beatHighScore = false;
}

function update() {
  // Desktop keyboard (still works)
  if ((keys.ArrowLeft || keys.a) && paddle.x > 0) paddle.x -= paddle.speed;
  if ((keys.ArrowRight || keys.d) && paddle.x < canvas.width - paddle.w) paddle.x += paddle.speed;

  box.y += box.speed;

  if (
    box.y + box.s >= paddle.y &&
    box.x + box.s >= paddle.x &&
    box.x <= paddle.x + paddle.w
  ) {
    score++;
    box.y = 0;
    box.x = Math.random()*(canvas.width - box.s);

    if (mode === "normal") box.speed += 0.15;
    if (mode === "hard") box.speed += 0.5;
  }

  if (box.y > canvas.height) {
    gameState = "gameover";
    if (score > highScore) {
      highScore = score;
      localStorage.setItem("highScore", highScore);
      beatHighScore = true;
    }
  }
}

function draw() {
  ctx.fillStyle = bgColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if (gameState === "menu") return;

  ctx.fillStyle = paddleColor;
  ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);

  ctx.fillStyle = boxColor;
  ctx.fillRect(box.x, box.y, box.s, box.s);

  ctx.fillStyle = "white";
  ctx.font = "18px Arial";
  ctx.fillText("Score: " + score, 10, 30);
  ctx.fillText("High Score: " + highScore, 10, 55);

  if (gameState === "gameover") {
    ctx.fillStyle = "red";
    ctx.font = "30px Arial";
    ctx.fillText("GAME OVER", 105, 280);
    ctx.font = "20px Arial";
    ctx.fillStyle = "white";
    ctx.fillText("Final Score: " + score, 125, 320);

    if (beatHighScore) {
      ctx.fillStyle = "yellow";
      ctx.fillText("You beat your high score!", 60, 355);
    }

    ctx.fillStyle = "white";
    ctx.fillText("Tap to restart", 135, 390);
  }
}

function loop() {
  if (gameState === "playing") update();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* ---------- TOUCH DRAG (MOBILE) ---------- */
canvas.addEventListener("touchstart", e => {
  dragging = true;
});

canvas.addEventListener("touchmove", e => {
  if (!dragging || gameState !== "playing") return;
  const rect = canvas.getBoundingClientRect();
  const touchX = e.touches[0].clientX - rect.left;
  paddle.x = touchX - paddle.w / 2;
  paddle.x = Math.max(0, Math.min(canvas.width - paddle.w, paddle.x));
});

canvas.addEventListener("touchend", () => dragging = false);

/* ---------- MOUSE DRAG (DESKTOP BONUS) ---------- */
canvas.addEventListener("mousedown", () => dragging = true);
canvas.addEventListener("mousemove", e => {
  if (!dragging || gameState !== "playing") return;
  const rect = canvas.getBoundingClientRect();
  paddle.x = e.clientX - rect.left - paddle.w / 2;
});
canvas.addEventListener("mouseup", () => dragging = false);

/* ---------- INPUT ---------- */
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

/* ---------- SETTINGS ---------- */
document.getElementById("settingsBtn").onclick = () => {
  gameState = "paused";
  document.getElementById("settingsMenu").style.display = "flex";
};

function closeSettings() {
  document.getElementById("settingsMenu").style.display = "none";
  if (gameState === "paused") gameState = "playing";
}

/* ---------- COLOR PICKERS ---------- */
document.querySelectorAll(".colorBar").forEach(bar => {
  bar.addEventListener("mousedown", pickColor);
  bar.addEventListener("touchstart", pickColor);

  function pickColor(e) {
    const picker = bar.querySelector(".colorPicker");
    const rect = bar.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const x = Math.max(0, Math.min(rect.width, clientX - rect.left));
    picker.style.left = (x - 8) + "px";

    const temp = document.createElement("canvas").getContext("2d");
    temp.canvas.width = rect.width;
    temp.canvas.height = 1;

    const g = temp.createLinearGradient(0,0,rect.width,0);
    ["red","orange","yellow","green","cyan","blue","violet"]
      .forEach((c,i)=>g.addColorStop(i/6,c));

    temp.fillStyle = g;
    temp.fillRect(0,0,rect.width,1);

    const d = temp.getImageData(x,0,1,1).data;
    const color = `rgb(${d[0]},${d[1]},${d[2]})`;

    if (bar.dataset.target === "box") boxColor = color;
    if (bar.dataset.target === "paddle") paddleColor = color;
    if (bar.dataset.target === "bg") bgColor = color;
  }
});
</script>

</body>
</html>
